<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetalRecord - Gold & Silver Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #0f4c75;
            --primary-light: #3282b8;
            --secondary: #bb9b5f;
            --secondary-light: #d4b97a;
            --accent: #1b262c;
            --success: #2d8c5e;
            --danger: #c74b50;
            --warning: #d97706;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --border-radius: 12px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--dark);
            overflow-x: hidden;
            transition: var(--transition);
            line-height: 1.6;
        }
        .wrapper {
            display: flex;
            min-height: 100vh;
        }
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-light);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        .logo i {
            color: var(--secondary);
            margin-right: 0.5rem;
        }
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .search-bar {
            max-width: 300px;
            width: 100%;
        }
        .search-bar input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background: var(--light);
            color: var(--dark);
            transition: var(--transition);
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 76, 117, 0.1);
        }
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 0.25rem;
        }
        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--primary-light);
            margin: 3px 0;
            transition: 0.3s;
        }
        .side-menu {
            width: 250px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--gray-light);
            padding: 2rem 0;
            position: fixed;
            left: 0;
            top: 70px;
            bottom: 0;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 999;
        }
        .side-menu ul {
            list-style: none;
        }
        .side-menu li {
            margin: 0.5rem 1rem;
        }
        .side-menu a {
            display: flex;
            align-items: center;
            padding: 1rem;
            color: var(--primary-light);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
        }
        .side-menu a:hover, .side-menu a.active {
            background: rgba(15, 76, 117, 0.1);
            color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 1px 3px rgba(15, 76, 117, 0.1);
        }
        .side-menu i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
        }
        .main-content {
            margin-left: 250px;
            margin-top: 70px;
            padding: 2rem;
            flex: 1;
            animation: fadeIn 0.5s ease;
            width: calc(100% - 250px);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .section {
            display: none;
            animation: slideIn 0.4s ease;
        }
        .section.active {
            display: block;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }
        .stat-profit { color: var(--success); }
        .stat-loss { color: var(--danger); }
        .metal-section {
            margin-bottom: 2rem;
        }
        .metal-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
            font-weight: 600;
        }
        .metal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--gray-light);
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            margin: 0 0.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-light);
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(15, 76, 117, 0.2);
        }
        .btn-secondary {
            background: var(--secondary);
            color: var(--dark);
        }
        .btn-secondary:hover {
            background: var(--secondary-light);
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(187, 155, 95, 0.2);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background: #b03c41;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(199, 75, 80, 0.2);
        }
        .btn-edit {
            background: var(--accent);
            color: white;
        }
        .btn-edit:hover {
            background: #2a3a42;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(27, 38, 44, 0.2);
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .controls select, .controls input {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            background: #ffffff;
            color: var(--dark);
            margin-right: 0.5rem;
        }
        .form-section {
            margin-bottom: 2rem;
            padding: 2.5rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(20px);
            border-left: 4px solid var(--secondary);
        }
        .form-section h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        .form-section h3 i {
            margin-right: 0.75rem;
            color: var(--secondary);
        }
        .form-section p {
            color: var(--gray);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--primary-light);
            display: flex;
            align-items: center;
        }
        .form-group label i {
            margin-right: 0.5rem;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        .form-group input, .form-group select {
            padding: 1rem;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            background: #ffffff;
            color: var(--dark);
            font-size: 1rem;
            width: 100%;
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 76, 117, 0.1);
            transform: translateY(-2px);
        }
        .form-group input::placeholder {
            color: var(--gray);
        }
        .form-group .full-width {
            grid-column: 1 / -1;
        }
        .transaction-type {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .type-option {
            flex: 1;
            text-align: center;
            padding: 1.5rem 1rem;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }
        .type-option.active {
            border-color: var(--primary);
            background: rgba(15, 76, 117, 0.05);
            box-shadow: 0 4px 6px -1px rgba(15, 76, 117, 0.1);
        }
        .type-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--primary);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
            overflow: auto;
            padding: 1rem;
        }
        .modal-content {
            background: #ffffff;
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--gray-light);
            box-shadow: var(--shadow);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal input, .modal select, .modal textarea {
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            background: #ffffff;
            color: var(--dark);
            width: 100%;
            font-size: 1rem;
        }
        .modal input::placeholder, .modal textarea::placeholder {
            color: var(--gray);
        }
        .close {
            color: var(--gray);
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1;
        }
        .close:hover {
            color: var(--primary);
        }
        .toast {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: rgba(45, 140, 94, 0.95);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 3000;
            transform: translateX(400px);
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.error {
            background: rgba(199, 75, 80, 0.95);
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-light);
        }
        .transaction-section {
            margin-bottom: 2rem;
        }
        .transaction-section h4 {
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
            font-weight: 600;
        }
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .section-title i {
            margin-right: 0.75rem;
            color: var(--secondary);
        }
        h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .badge-purchase {
            background: rgba(45, 140, 94, 0.2);
            color: var(--success);
        }
        .badge-sale {
            background: rgba(199, 75, 80, 0.2);
            color: var(--danger);
        }
        .currency-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .profit-indicator {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-light);
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .report-option {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }
        .report-option:hover {
            transform: translateY(-5px);
        }
        .report-option i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        .report-option h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        .goal-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            position: relative;
        }
        .goal-card h3 {
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--gray-light);
            border-radius: 5px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
            border-radius: 5px;
        }
        .progress-text {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }
        .goal-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .goal-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        @media (max-width: 1024px) {
            .side-menu {
                transform: translateX(-100%);
                width: 280px;
            }
   
            .side-menu.active {
                transform: translateX(0);
            }
   
            .main-content {
                margin-left: 0;
                width: 100%;
            }
   
            .hamburger {
                display: flex;
            }
   
            .search-bar {
                max-width: 200px;
            }
        }
        @media (max-width: 768px) {
            .top-nav {
                padding: 1rem;
            }
   
            .logo {
                font-size: 1.25rem;
            }
   
            .search-bar {
                display: none;
            }
   
            .search-bar.active {
                display: block;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                padding: 1rem;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                max-width: 100%;
            }
   
            .main-content {
                padding: 1rem;
            }
   
            .glass-card {
                padding: 1.5rem;
            }
   
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
   
            .metal-grid {
                grid-template-columns: 1fr;
            }
   
            .form-grid {
                grid-template-columns: 1fr;
            }
   
            .transaction-type {
                flex-direction: column;
            }
   
            .form-actions {
                flex-direction: column;
            }
   
            .form-actions button {
                width: 100%;
            }
   
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
   
            .controls select, .controls input {
                margin-right: 0;
                margin-bottom: 0.5rem;
                width: 100%;
            }
   
            .chart-container {
                height: 300px;
            }
   
            .toast {
                right: 1rem;
                left: 1rem;
                text-align: center;
            }
   
            .modal-content {
                margin: 10% auto;
                padding: 1.5rem;
            }
   
            .goals-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .modal-content {
                padding: 1rem;
                margin: 5% auto;
            }
   
            .close {
                top: 10px;
                right: 15px;
                font-size: 24px;
            }
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        .overlay.active {
            display: block;
        }
        .search-toggle {
            display: none;
        }
        @media (max-width: 768px) {
            .search-toggle {
                display: block;
            }
        }
        /* Backup & Sync Styles */
        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .sync-option {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        .sync-option:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        .sync-option i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .sync-option h4 {
            color: var(--primary);
            margin-bottom: 1rem;
        }
        .sync-option p {
            color: var(--gray);
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .backup-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        @media (max-width: 768px) {
            .sync-options {
                grid-template-columns: 1fr;
            }
   
            .backup-actions {
                flex-direction: column;
            }
   
            .backup-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <nav class="top-nav">
            <div class="logo">
                <i class="fas fa-gem"></i>
                <span>MetalRecord</span>
            </div>
            <div class="nav-controls">
                <div class="search-bar" id="searchBar">
                    <input type="text" id="searchInput" placeholder="Search transactions...">
                </div>
                <button class="btn btn-primary search-toggle" id="searchToggle">
                    <i class="fas fa-search"></i>
                </button>
                <div class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
        <div class="overlay" id="overlay"></div>
        <aside class="side-menu" id="sideMenu">
            <ul>
                <li><a href="#" class="nav-link active" data-section="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-section="transactions"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li><a href="#" class="nav-link" data-section="analytics"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li><a href="#" class="nav-link" data-section="goals"><i class="fas fa-bullseye"></i> Investment Goals</a></li>
                <li><a href="#" class="nav-link" data-section="reports"><i class="fas fa-file-alt"></i> Reports</a></li>
                <li><a href="#" class="nav-link" data-section="backup"><i class="fas fa-cloud"></i> Backup & Sync</a></li>
                <li><a href="#" class="nav-link" onclick="exportPDF(); return false;"><i class="fas fa-download"></i> Export PDF</a></li>
            </ul>
        </aside>
        <main class="main-content">
            <section id="dashboard" class="section active">
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        <h2>Overview</h2>
                    </div>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value total-transactions" id="totalTransactions">0</div>
                            <div class="stat-label">Total Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value total-weight" id="totalWeight">0g</div>
                            <div class="stat-label">Remaining Weight</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value total-investment" id="totalInvestment">₹0.00</div>
                            <div class="stat-label">Total Investment (Purchase - Sales)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value profit-loss-amount" id="profitLossAmount">₹0.00</div>
                            <div class="stat-label">Realized Profit/Loss (SP - CP)</div>
                            <div class="profit-indicator" id="profitIndicator"></div>
                        </div>
                    </div>
           
                    <div class="metal-section">
                        <h3>Gold Performance</h3>
                        <div class="metal-grid">
                            <div class="stat-card">
                                <div class="stat-value gold-weight" id="goldWeight">0g</div>
                                <div class="stat-label">Remaining Gold Weight</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value gold-avg-price" id="goldAvgPrice">₹0.00/g</div>
                                <div class="stat-label">Avg. Purchase Price</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value gold-profit" id="goldProfit">₹0.00</div>
                                <div class="stat-label">Gold Realized Profit/Loss (SP - CP)</div>
                                <div class="profit-indicator" id="goldProfitIndicator"></div>
                            </div>
                        </div>
                    </div>
           
                    <div class="metal-section">
                        <h3>Silver Performance</h3>
                        <div class="metal-grid">
                            <div class="stat-card">
                                <div class="stat-value silver-weight" id="silverWeight">0g</div>
                                <div class="stat-label">Remaining Silver Weight</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value silver-avg-price" id="silverAvgPrice">₹0.00/g</div>
                                <div class="stat-label">Avg. Purchase Price</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value silver-profit" id="silverProfit">₹0.00</div>
                                <div class="stat-label">Silver Realized Profit/Loss (SP - CP)</div>
                                <div class="profit-indicator" id="silverProfitIndicator"></div>
                            </div>
                        </div>
                    </div>
                </div>
       
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <h2>Recent Transactions</h2>
                    </div>
                    <div class="table-container">
                        <table id="recentTable">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Metal</th>
                                    <th>Date</th>
                                    <th>Weight (g)</th>
                                    <th>Price/g</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="recentBody">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <div>No transactions yet</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
   
            <section id="transactions" class="section">
                <div class="form-section">
                    <h3><i class="fas fa-plus-circle"></i> Add New Transaction</h3>
                    <p style="margin-bottom: 1.5rem; color: var(--gray); font-size: 0.95rem;">Fill in all details below. Price per gram is optional – it will use a standard rate if left blank.</p>
           
                    <div class="transaction-type">
                        <div class="type-option active" data-type="purchase">
                            <i class="fas fa-shopping-cart"></i>
                            <div>Purchase</div>
                            <small>Buy precious metals</small>
                        </div>
                        <div class="type-option" data-type="sale">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>Sale</div>
                            <small>Sell precious metals</small>
                        </div>
                    </div>
           
                    <form id="addForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="addMetal"><i class="fas fa-gem"></i> Metal Type *</label>
                                <select id="addMetal" required>
                                    <option value="">Select Metal</option>
                                    <option value="Gold">Gold</option>
                                    <option value="Silver">Silver</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="addCurrency"><i class="fas fa-money-bill-wave"></i> Currency *</label>
                                <select id="addCurrency" required>
                                    <option value="INR">INR ₹</option>
                                    <option value="USD">USD $</option>
                                    <option value="EUR">EUR €</option>
                                    <option value="GBP">GBP £</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="addDate"><i class="fas fa-calendar-alt"></i> Transaction Date *</label>
                                <input type="date" id="addDate" required>
                            </div>
                            <div class="form-group">
                                <label for="addWeight"><i class="fas fa-weight-hanging"></i> Weight (grams) *</label>
                                <input type="number" id="addWeight" placeholder="e.g., 10.50" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="addPricePerGram"><i class="fas fa-tag"></i> Price per Gram (optional)</label>
                                <input type="number" id="addPricePerGram" placeholder="e.g., 65.00" step="0.01">
                            </div>
                            <div class="form-group" id="saleDateContainer" style="display: none;">
                                <label for="addSaleDate"><i class="fas fa-calendar-check"></i> Sale Date *</label>
                                <input type="date" id="addSaleDate">
                            </div>
                            <div class="form-group full-width">
                                <label for="addSource"><i class="fas fa-sticky-note"></i> Source/Shop/Notes</label>
                                <input type="text" id="addSource" placeholder="e.g., Local jeweler - Invoice #123">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="reset" class="btn" style="background: var(--gray-light); color: var(--dark);">
                                <i class="fas fa-redo"></i> Clear Form
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Transaction
                            </button>
                        </div>
                    </form>
                </div>
       
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <h3>Transaction History</h3>
                    </div>
                    <div class="controls">
                        <div>
                            <input type="text" id="searchInputTrans" placeholder="Search by notes/source..." onkeyup="filterTable()">
                            <select id="metalFilter" onchange="filterTable()">
                                <option value="">All Metals</option>
                                <option value="Gold">Gold</option>
                                <option value="Silver">Silver</option>
                            </select>
                            <select id="typeFilter" onchange="filterTable()">
                                <option value="">All Types</option>
                                <option value="purchase">Purchase</option>
                                <option value="sale">Sale</option>
                            </select>
                            <input type="date" id="dateFilter" onchange="filterTable()">
                        </div>
                    </div>
                    <div id="transactionSections">
                        <!-- Transaction sections will be dynamically generated here -->
                    </div>
                </div>
            </section>
   
            <section id="analytics" class="section">
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        <h2>Analytics</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="valueAllocationChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="profitBarChart"></canvas>
                    </div>
                </div>
            </section>
            <section id="goals" class="section">
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-bullseye"></i>
                        <h2>Investment Goals & Progress</h2>
                    </div>
                    <div class="form-section">
                        <h3><i class="fas fa-edit"></i> Set Goal for Metal</h3>
                        <p style="margin-bottom: 1.5rem; color: var(--gray); font-size: 0.95rem;">Define target weight for a specific metal to track progress towards your investment goal.</p>
                        <form id="goalsForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="goalMetal"><i class="fas fa-gem"></i> Metal for Goal *</label>
                                    <select id="goalMetal" required>
                                        <option value="">Select Metal</option>
                                        <option value="Gold">Gold</option>
                                        <option value="Silver">Silver</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="targetWeight"><i class="fas fa-weight-hanging"></i> Target Weight (g) *</label>
                                    <input type="number" id="targetWeight" step="0.01" placeholder="e.g., 100" required>
                                </div>
                                <div class="form-group">
                                    <label for="targetDate"><i class="fas fa-calendar-alt"></i> Target Date</label>
                                    <input type="date" id="targetDate">
                                </div>
                                <div class="form-group full-width">
                                    <label for="goalNotes"><i class="fas fa-sticky-note"></i> Goal Notes</label>
                                    <textarea id="goalNotes" placeholder="e.g., Save for retirement..."></textarea>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Goal
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="goals-grid" id="goalsProgress">
                        <!-- Progress will be dynamically generated here -->
                    </div>
                </div>
            </section>
            <section id="reports" class="section">
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-file-alt"></i>
                        <h2>Generate Reports</h2>
                    </div>
                    <div class="report-grid">
                        <div class="report-option" onclick="generateYearlyReport()">
                            <i class="fas fa-calendar-year"></i>
                            <h4>Yearly Summary</h4>
                            <p>Get a comprehensive report of your transactions for a specific year.</p>
                        </div>
                    </div>
                </div>
            </section>
            <!-- BACKUP & SYNC SECTION -->
            <section id="backup" class="section">
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-cloud"></i>
                        <h2>Backup & Sync Your Data</h2>
                    </div>
                    <p style="margin-bottom: 2rem; color: var(--gray);">Save your MetalRecord data to your email and access it from any device.</p>
           
                    <div class="sync-options">
                        <div class="sync-option">
                            <i class="fas fa-file-export"></i>
                            <h4>Export Data</h4>
                            <p>Download your data as a file that you can email to yourself</p>
                            <button class="btn btn-primary" onclick="exportData()">
                                <i class="fas fa-download"></i> Export Data File
                            </button>
                        </div>
               
                        <div class="sync-option">
                            <i class="fas fa-file-import"></i>
                            <h4>Import Data</h4>
                            <p>Upload your data file to restore your transactions</p>
                            <div>
                                <input type="file" id="importFile" accept=".json" style="display: none;">
                                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                                    <i class="fas fa-upload"></i> Choose File
                                </button>
                            </div>
                        </div>
               
                        <div class="sync-option">
                            <i class="fas fa-file-csv"></i>
                            <h4>Export CSV</h4>
                            <p>Download your transactions as a CSV file for spreadsheets</p>
                            <button class="btn btn-primary" onclick="exportCSV()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn btn-secondary" onclick="showManualBackup()">
                            <i class="fas fa-code"></i> Manual Backup
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> Clear All Data
                        </button>
                    </div>
                </div>
                <!-- Manual Backup Section -->
                <div class="glass-card" id="manualBackupSection" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-code"></i>
                        <h3>Manual Backup</h3>
                    </div>
                    <p style="margin-bottom: 1rem; color: var(--gray);">Copy this data and save it in a text file or email it to yourself:</p>
                    <textarea id="backupData" style="width: 100%; height: 200px; padding: 1rem; border: 1px solid var(--gray-light); border-radius: var(--border-radius); font-family: monospace; resize: vertical;"></textarea>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="hideManualBackup()">Close</button>
                        <button class="btn btn-primary" onclick="copyBackupData()">
                            <i class="fas fa-copy"></i> Copy to Clipboard
                        </button>
                    </div>
                </div>
                <!-- Restore Section -->
                <div class="glass-card">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <h3>Restore from Backup</h3>
                    </div>
                    <p style="margin-bottom: 1rem; color: var(--gray);">Paste your backup data here to restore (this will add to existing data):</p>
                    <textarea id="restoreData" placeholder="Paste your backup data here..." style="width: 100%; height: 150px; padding: 1rem; border: 1px solid var(--gray-light); border-radius: var(--border-radius); font-family: monospace; resize: vertical;"></textarea>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="restoreFromBackup()">
                            <i class="fas fa-upload"></i> Restore Data
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- Edit Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Edit Transaction</h3>
            <form id="editForm">
                <div class="form-group">
                    <label for="editType">Transaction Type *</label>
                    <select id="editType" required>
                        <option value="purchase">Purchase</option>
                        <option value="sale">Sale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editMetal">Metal Type *</label>
                    <select id="editMetal" required>
                        <option value="">Select Metal</option>
                        <option value="Gold">Gold</option>
                        <option value="Silver">Silver</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCurrency">Currency *</label>
                    <select id="editCurrency" required>
                        <option value="INR">INR ₹</option>
                        <option value="USD">USD $</option>
                        <option value="EUR">EUR €</option>
                        <option value="GBP">GBP £</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editDate">Transaction Date *</label>
                    <input type="date" id="editDate" required>
                </div>
                <div class="form-group">
                    <label for="editWeight">Weight (grams) *</label>
                    <input type="number" id="editWeight" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editPricePerGram">Price per Gram (optional)</label>
                    <input type="number" id="editPricePerGram" step="0.01">
                </div>
                <div class="form-group" id="editSaleDateContainer" style="display: none;">
                    <label for="editSaleDate">Sale Date *</label>
                    <input type="date" id="editSaleDate">
                </div>
                <div class="form-group">
                    <label for="editSource">Source/Shop/Notes</label>
                    <input type="text" id="editSource" placeholder="e.g., Local jeweler - Invoice #123">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Transaction</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>
            <div class="form-actions">
                <button class="btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
    <!-- Goal Edit Modal -->
    <div id="goalEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGoalModal()">&times;</span>
            <h3>Edit Goal</h3>
            <form id="editGoalForm">
                <div class="form-group">
                    <label for="editGoalMetal">Metal *</label>
                    <select id="editGoalMetal" required>
                        <option value="Gold">Gold</option>
                        <option value="Silver">Silver</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editTargetWeight">Target Weight (g) *</label>
                    <input type="number" id="editTargetWeight" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editTargetDate">Target Date</label>
                    <input type="date" id="editTargetDate">
                </div>
                <div class="form-group full-width">
                    <label for="editGoalNotes">Goal Notes</label>
                    <textarea id="editGoalNotes"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Goal</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    <script>
        // Initialize application data
        let transactions = JSON.parse(localStorage.getItem('metalrecord-transactions')) || [];
        let goals = JSON.parse(localStorage.getItem('metalrecord-goals')) || { Gold: { target: 0, date: '', notes: '' }, Silver: { target: 0, date: '', notes: '' } };
        let editingGoalMetal = null;
        let sortDirection = {};
        let editingId = null;
        let deleteId = null;
        let lineChart, barChart, pieChart, valueAllocationChart, profitBarChart;
        let currentTransactionType = 'purchase';
        // Currency symbols
        const currencySymbols = {
            'INR': '₹',
            'USD': '$',
            'EUR': '€',
            'GBP': '£'
        };
        // PDF-safe currency symbols (replaces ₹ with Rs. to avoid rendering issues)
        const pdfCurrencySymbols = {
            'INR': 'Rs. ',
            'USD': '$',
            'EUR': '€',
            'GBP': '£'
        };
        // Format currency for UI
        function formatCurrency(amount, currency) {
            return `${currencySymbols[currency]}${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        // Format currency for PDF (safe rendering)
        function pdfFormatCurrency(amount, currency) {
            return `${pdfCurrencySymbols[currency]}${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        // Format amount for PDF without currency symbol (for price/g and total columns)
        function pdfFormatAmount(amount) {
            return amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        // Check for duplicate transaction and merge if found
        function findAndMergeDuplicate(newTrans, searchArray = transactions) {
            return searchArray.findIndex(existing =>
                existing.type === newTrans.type &&
                existing.metal === newTrans.metal &&
                existing.currency === newTrans.currency &&
                existing.date === newTrans.date &&
                (existing.pricePerGram === newTrans.pricePerGram || (existing.pricePerGram === 0 && newTrans.pricePerGram === 0)) &&
                existing.source === newTrans.source &&
                (newTrans.type !== 'sale' || (existing.saleDate && existing.saleDate === newTrans.saleDate))
            );
        }
        // Get summary data - UPDATED: Total investment is now Purchase Amount - Sale Amount
        function getSummaryData() {
            const purchases = transactions.filter(t => t.type !== 'sale');
            const sales = transactions.filter(t => t.type === 'sale');
            const totalTransactionsCount = transactions.length;
           
            // Total Investment: Purchase Amount - Sale Amount
            const totalPurchaseAmount = purchases.reduce((sum, t) => sum + t.total, 0);
            const totalSaleAmount = sales.reduce((sum, t) => sum + t.total, 0);
            const totalInvestment = totalPurchaseAmount - totalSaleAmount;
           
            // Profit/Loss: Sale Price - Cost Price (for sold items only)
            const profitLoss = totalSaleAmount - totalPurchaseAmount;
           
            // Gold
            const goldPurchases = purchases.filter(t => t.metal === 'Gold');
            const goldSales = sales.filter(t => t.metal === 'Gold');
            const goldPurchasedWeight = goldPurchases.reduce((sum, t) => sum + t.weight, 0);
            const goldSoldWeight = Math.min(goldSales.reduce((sum, t) => sum + t.weight, 0), goldPurchasedWeight);
            const goldNetWeight = Math.max(0, goldPurchasedWeight - goldSoldWeight);
            const goldPurchaseAmount = goldPurchases.reduce((sum, t) => sum + t.total, 0);
            const goldSaleAmount = goldSales.reduce((sum, t) => sum + t.total, 0);
            const goldProfit = goldSaleAmount - goldPurchaseAmount;
            const goldAvgPrice = goldPurchasedWeight > 0 ? goldPurchaseAmount / goldPurchasedWeight : 0;
           
            // Silver
            const silverPurchases = purchases.filter(t => t.metal === 'Silver');
            const silverSales = sales.filter(t => t.metal === 'Silver');
            const silverPurchasedWeight = silverPurchases.reduce((sum, t) => sum + t.weight, 0);
            const silverSoldWeight = Math.min(silverSales.reduce((sum, t) => sum + t.weight, 0), silverPurchasedWeight);
            const silverNetWeight = Math.max(0, silverPurchasedWeight - silverSoldWeight);
            const silverPurchaseAmount = silverPurchases.reduce((sum, t) => sum + t.total, 0);
            const silverSaleAmount = silverSales.reduce((sum, t) => sum + t.total, 0);
            const silverProfit = silverSaleAmount - silverPurchaseAmount;
            const silverAvgPrice = silverPurchasedWeight > 0 ? silverPurchaseAmount / silverPurchasedWeight : 0;
           
            const totalNetWeight = goldNetWeight + silverNetWeight;
           
            return {
                totalTransactionsCount,
                totalNetWeight,
                totalInvestment,
                profitLoss,
                goldNetWeight,
                goldAvgPrice,
                goldProfit,
                silverNetWeight,
                silverAvgPrice,
                silverProfit,
                goldPurchaseAmount,
                silverPurchaseAmount
            };
        }
        // Update goals progress
        function updateGoalsProgress() {
            const data = getSummaryData();
            const container = document.getElementById('goalsProgress');
            container.innerHTML = '';
   
            ['Gold', 'Silver'].forEach(metal => {
                const goal = goals[metal];
                if (goal.target <= 0) return;
                const netWeight = metal === 'Gold' ? data.goldNetWeight : data.silverNetWeight;
                const progressWidth = Math.min((netWeight / goal.target) * 100, 100);
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <div class="goal-actions">
                        <button class="btn btn-edit" onclick="editGoal('${metal}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="deleteGoal('${metal}')"><i class="fas fa-trash"></i></button>
                    </div>
                    <h3>${metal} Goal Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}%"></div>
                    </div>
                    <div class="progress-text">Current Weight: ${netWeight.toFixed(2)}g / Target: ${goal.target}g</div>
                    ${goal.date ? `<div class="progress-text">Target Date: ${goal.date}</div>` : ''}
                    ${goal.notes ? `<div class="progress-text">Notes: ${goal.notes}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }
        // Edit goal
        function editGoal(metal) {
            editingGoalMetal = metal;
            document.getElementById('editGoalMetal').value = metal;
            document.getElementById('editTargetWeight').value = goals[metal].target;
            document.getElementById('editTargetDate').value = goals[metal].date;
            document.getElementById('editGoalNotes').value = goals[metal].notes;
            document.getElementById('goalEditModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        // Close goal modal
        function closeGoalModal() {
            document.getElementById('goalEditModal').style.display = 'none';
            editingGoalMetal = null;
            document.body.style.overflow = 'auto';
        }
        // Delete goal
        function deleteGoal(metal) {
            if (confirm(`Are you sure you want to delete the ${metal} goal?`)) {
                goals[metal] = { target: 0, date: '', notes: '' };
                localStorage.setItem('metalrecord-goals', JSON.stringify(goals));
                updateGoalsProgress();
                showToast(`${metal} goal deleted successfully!`);
            }
        }
        // Toggle mobile menu
        function toggleMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const hamburger = document.getElementById('hamburger');
            const overlay = document.getElementById('overlay');
   
            sideMenu.classList.toggle('active');
            hamburger.classList.toggle('active');
            overlay.classList.toggle('active');
   
            document.body.style.overflow = sideMenu.classList.contains('active') ? 'hidden' : 'auto';
        }
        // Toggle search bar on mobile
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('active');
        }
        // Show section
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(s => s.classList.remove('active'));
   
            document.getElementById(sectionId).classList.add('active');
   
            const navLinks = document.querySelectorAll('.side-menu a.nav-link');
            navLinks.forEach(a => a.classList.remove('active'));
            const activeLink = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeLink) activeLink.classList.add('active');
   
            if (window.innerWidth < 1024) {
                toggleMenu();
            }
   
            if (sectionId === 'analytics') {
                updateCharts();
            }
   
            if (sectionId === 'transactions') {
                updateTransactionSections();
            }
   
            if (sectionId === 'goals') {
                updateGoalsProgress();
            }
   
            if (sectionId === 'dashboard') {
                updateRecentTransactions();
                updateSummary();
            }
        }
        // Update transaction type
        function updateTransactionType(type) {
            currentTransactionType = type;
            const options = document.querySelectorAll('.type-option');
            options.forEach(opt => {
                opt.classList.toggle('active', opt.dataset.type === type);
            });
   
            const saleDateContainer = document.getElementById('saleDateContainer');
            saleDateContainer.style.display = type === 'sale' ? 'block' : 'none';
            document.getElementById('addSaleDate').required = type === 'sale';
        }
        // Modal functions
        function openModal(id) {
            editingId = id;
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('editForm');
            form.reset();
            const trans = transactions.find(t => t.id === id);
            if (trans) {
                document.getElementById('editType').value = trans.type || 'purchase';
                document.getElementById('editMetal').value = trans.metal;
                document.getElementById('editCurrency').value = trans.currency || 'INR';
                document.getElementById('editDate').value = trans.date;
                document.getElementById('editWeight').value = trans.weight;
                document.getElementById('editPricePerGram').value = trans.pricePerGram || '';
                document.getElementById('editSource').value = trans.source || '';
       
                const saleDateContainer = document.getElementById('editSaleDateContainer');
                if (trans.type === 'sale' && trans.saleDate) {
                    saleDateContainer.style.display = 'block';
                    document.getElementById('editSaleDate').value = trans.saleDate;
                    document.getElementById('editSaleDate').required = true;
                } else {
                    saleDateContainer.style.display = 'none';
                    document.getElementById('editSaleDate').required = false;
                }
       
                title.textContent = 'Edit Transaction';
            }
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
   
            setTimeout(() => {
                const firstInput = form.querySelector('input, select');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
            editingId = null;
            document.body.style.overflow = 'auto';
        }
        function openDeleteModal(id) {
            deleteId = id;
            document.getElementById('deleteModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteId = null;
            document.body.style.overflow = 'auto';
        }
        // Delete confirmation
        function confirmDelete() {
            if (deleteId !== null) {
                transactions = transactions.filter(t => t.id !== deleteId);
                localStorage.setItem('metalrecord-transactions', JSON.stringify(transactions));
                showToast('Transaction deleted successfully!');
                closeDeleteModal();
                updateSummary();
                updateTransactionSections();
                updateCharts();
                updateRecentTransactions();
                updateGoalsProgress();
            }
        }
        // Update dashboard summary
        function updateSummary() {
            const data = getSummaryData();
   
            const elements = {
                totalTransactions: data.totalTransactionsCount,
                totalWeight: `${data.totalNetWeight.toFixed(2)}g`,
                totalInvestment: formatCurrency(data.totalInvestment, 'INR'),
                profitLossAmount: formatCurrency(data.profitLoss, 'INR'),
                goldWeight: `${data.goldNetWeight.toFixed(2)}g`,
                goldAvgPrice: `${formatCurrency(data.goldAvgPrice, 'INR')}/g`,
                goldProfit: formatCurrency(data.goldProfit, 'INR'),
                silverWeight: `${data.silverNetWeight.toFixed(2)}g`,
                silverAvgPrice: `${formatCurrency(data.silverAvgPrice, 'INR')}/g`,
                silverProfit: formatCurrency(data.silverProfit, 'INR')
            };
   
            Object.entries(elements).forEach(([key, value]) => {
                const el = document.getElementById(key);
                if (el) {
                    el.style.transition = 'all 0.5s ease';
                    el.textContent = value;
                }
            });
   
            updateProfitIndicator('profitIndicator', data.profitLoss);
            updateProfitIndicator('goldProfitIndicator', data.goldProfit);
            updateProfitIndicator('silverProfitIndicator', data.silverProfit);
        }
        // Update profit indicator
        function updateProfitIndicator(elementId, profit) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                if (profit > 0) {
                    indicator.innerHTML = `<span style="color: var(--success)">▲ Profit (SP > CP)</span>`;
                } else if (profit < 0) {
                    indicator.innerHTML = `<span style="color: var(--danger)">▼ Loss (SP < CP)</span>`;
                } else {
                    indicator.innerHTML = `<span style="color: var(--gray)">- Break Even (SP = CP)</span>`;
                }
            }
        }
        // Update recent transactions
        function updateRecentTransactions() {
            const tbody = document.getElementById('recentBody');
            tbody.innerHTML = '';
   
            const recent = [...transactions]
                .sort((a, b) => {
                    const aDate = a.type === 'sale' ? (a.saleDate || a.date) : a.date;
                    const bDate = b.type === 'sale' ? (b.saleDate || b.date) : b.date;
                    return new Date(bDate) - new Date(aDate);
                })
                .slice(0, 5);
       
            if (recent.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <div>No transactions yet. Add one to get started!</div>
                        </td>
                    </tr>
                `;
                return;
            }
   
            recent.forEach(trans => {
                const row = tbody.insertRow();
                const typeBadge = trans.type === 'sale'
                    ? '<span class="badge badge-sale">Sale</span>'
                    : '<span class="badge badge-purchase">Buy</span>';
                const displayDate = trans.type === 'sale' ? (trans.saleDate || trans.date) : trans.date;
           
                row.innerHTML = `
                    <td>${typeBadge}</td>
                    <td><strong>${trans.metal}</strong></td>
                    <td>${new Date(displayDate).toLocaleDateString()}</td>
                    <td>${trans.weight.toFixed(2)}</td>
                    <td>${formatCurrency(trans.pricePerGram, trans.currency || 'INR')}</td>
                    <td>${formatCurrency(trans.total, trans.currency || 'INR')}</td>
                `;
            });
        }
        // Update transaction sections
        function updateTransactionSections(filtered = transactions) {
            const container = document.getElementById('transactionSections');
            container.innerHTML = '';
   
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <div>No transactions yet. Add one above to get started!</div>
                    </div>
                `;
                return;
            }
   
            const metals = ['Gold', 'Silver'];
   
            metals.forEach(metal => {
                const metalTransactions = filtered.filter(t => t.metal === metal);
       
                if (metalTransactions.length > 0) {
                    const metalSection = document.createElement('div');
                    metalSection.className = 'transaction-section';
           
                    const purchaseTransactions = metalTransactions.filter(t => t.type !== 'sale')
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
           
                    if (purchaseTransactions.length > 0) {
                        const purchaseSection = document.createElement('div');
                        purchaseSection.innerHTML = `
                            <h4>${metal} - Purchase Transactions</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Weight (g)</th>
                                            <th>Price/g</th>
                                            <th>Total</th>
                                            <th>Currency</th>
                                            <th>Source/Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${purchaseTransactions.map(trans => `
                                            <tr>
                                                <td>${new Date(trans.date).toLocaleDateString()}</td>
                                                <td>${trans.weight.toFixed(2)}</td>
                                                <td>${formatCurrency(trans.pricePerGram, trans.currency || 'INR')}</td>
                                                <td>${formatCurrency(trans.total, trans.currency || 'INR')}</td>
                                                <td><span class="currency-badge">${trans.currency || 'INR'}</span></td>
                                                <td>${trans.source || '-'}</td>
                                                <td>
                                                    <button class="btn btn-edit" onclick="openModal(${trans.id})" title="Edit"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-danger" onclick="openDeleteModal(${trans.id})" title="Delete"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        metalSection.appendChild(purchaseSection);
                    }
           
                    const saleTransactions = metalTransactions.filter(t => t.type === 'sale')
                        .sort((a, b) => {
                            const aDate = a.saleDate || a.date;
                            const bDate = b.saleDate || b.date;
                            return new Date(bDate) - new Date(aDate);
                        });
           
                    if (saleTransactions.length > 0) {
                        const saleSection = document.createElement('div');
                        saleSection.innerHTML = `
                            <h4>${metal} - Sale Transactions</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sale Date</th>
                                            <th>Weight (g)</th>
                                            <th>Price/g</th>
                                            <th>Total</th>
                                            <th>Currency</th>
                                            <th>Source/Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${saleTransactions.map(trans => `
                                            <tr>
                                                <td>${new Date(trans.saleDate || trans.date).toLocaleDateString()}</td>
                                                <td>${trans.weight.toFixed(2)}</td>
                                                <td>${formatCurrency(trans.pricePerGram, trans.currency || 'INR')}</td>
                                                <td>${formatCurrency(trans.total, trans.currency || 'INR')}</td>
                                                <td><span class="currency-badge">${trans.currency || 'INR'}</span></td>
                                                <td>${trans.source || '-'}</td>
                                                <td>
                                                    <button class="btn btn-edit" onclick="openModal(${trans.id})" title="Edit"><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-danger" onclick="openDeleteModal(${trans.id})" title="Delete"><i class="fas fa-trash"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        metalSection.appendChild(saleSection);
                    }
           
                    container.appendChild(metalSection);
                }
            });
        }
        // Filter table
        function filterTable() {
            const search = document.getElementById('searchInputTrans').value.toLowerCase();
            const metal = document.getElementById('metalFilter').value;
            const type = document.getElementById('typeFilter').value;
            const date = document.getElementById('dateFilter').value;
            let filtered = transactions.filter(t =>
                (!search || (t.source || '').toLowerCase().includes(search) || t.metal.toLowerCase().includes(search)) &&
                (!metal || t.metal === metal) &&
                (!type || t.type === type) &&
                (!date || (t.date === date || (t.saleDate && t.saleDate === date)))
            );
            updateTransactionSections(filtered);
        }
        // Global search
        function globalSearch() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            document.getElementById('searchInputTrans').value = search;
            filterTable();
        }
        // Update charts
        function updateCharts() {
            const data = getSummaryData();
   
            // Profit chart (replacing original lineChart - Growth Over Time)
            const profitCtx = document.getElementById('lineChart');
            if (profitCtx) {
                if (lineChart) lineChart.destroy();
       
                const profitMetals = [];
                const profitValues = [];
                if (data.goldProfit > 0) {
                    profitMetals.push('Gold');
                    profitValues.push(data.goldProfit);
                }
                if (data.silverProfit > 0) {
                    profitMetals.push('Silver');
                    profitValues.push(data.silverProfit);
                }
       
                if (profitMetals.length > 0) {
                    const canvas = profitCtx.getContext('2d');
                    lineChart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: profitMetals,
                            datasets: [{
                                label: 'Profit (SP - CP)',
                                data: profitValues,
                                backgroundColor: '#2d8c5e'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#6b7280',
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN');
                                        }
                                    },
                                    grid: { color: '#e5e7eb' }
                                }
                            },
                            plugins: {
                                legend: { labels: { color: '#374151' } },
                                title: {
                                    display: true,
                                    text: 'Profits by Metal',
                                    color: '#0f4c75',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeOutQuart' }
                        }
                    });
                } else {
                    const ctx = profitCtx.getContext('2d');
                    ctx.clearRect(0, 0, profitCtx.width, profitCtx.height);
                    ctx.font = '16px Inter';
                    ctx.fillStyle = '#6b7280';
                    ctx.textAlign = 'center';
                    ctx.fillText('No profits yet', profitCtx.width/2, profitCtx.height/2);
                }
            }
   
            // Loss chart (replacing original barChart - Investment by Metal)
            const lossCtx = document.getElementById('barChart');
            if (lossCtx) {
                if (barChart) barChart.destroy();
       
                const lossMetals = [];
                const lossValues = [];
                if (data.goldProfit < 0) {
                    lossMetals.push('Gold');
                    lossValues.push(Math.abs(data.goldProfit));
                }
                if (data.silverProfit < 0) {
                    lossMetals.push('Silver');
                    lossValues.push(Math.abs(data.silverProfit));
                }
       
                if (lossMetals.length > 0) {
                    const canvas = lossCtx.getContext('2d');
                    barChart = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: lossMetals,
                            datasets: [{
                                label: 'Loss (CP - SP)',
                                data: lossValues,
                                backgroundColor: '#c74b50'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#6b7280',
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN');
                                        }
                                    },
                                    grid: { color: '#e5e7eb' }
                                }
                            },
                            plugins: {
                                legend: { labels: { color: '#374151' } },
                                title: {
                                    display: true,
                                    text: 'Losses by Metal',
                                    color: '#0f4c75',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeOutQuart' }
                        }
                    });
                } else {
                    const ctx = lossCtx.getContext('2d');
                    ctx.clearRect(0, 0, lossCtx.width, lossCtx.height);
                    ctx.font = '16px Inter';
                    ctx.fillStyle = '#6b7280';
                    ctx.textAlign = 'center';
                    ctx.fillText('No losses yet', lossCtx.width/2, lossCtx.height/2);
                }
            }
            // Pie chart
            const pieCtx = document.getElementById('pieChart');
            if (pieCtx) {
                if (pieChart) pieChart.destroy();
       
                if (data.totalNetWeight > 0) {
                    const pieCanvas = pieCtx.getContext('2d');
                    pieChart = new Chart(pieCanvas, {
                        type: 'pie',
                        data: {
                            labels: ['Gold', 'Silver'],
                            datasets: [{
                                data: [data.goldNetWeight, data.silverNetWeight],
                                backgroundColor: ['#bb9b5f', '#c0c0c0'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#374151', position: 'bottom' }
                                },
                                title: {
                                    display: true,
                                    text: 'Remaining Weight Allocation',
                                    color: '#0f4c75',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeOutQuart' }
                        }
                    });
                } else {
                    const ctx = pieCtx.getContext('2d');
                    ctx.clearRect(0, 0, pieCtx.width, pieCtx.height);
                    ctx.font = '16px Inter';
                    ctx.fillStyle = '#6b7280';
                    ctx.textAlign = 'center';
                    ctx.fillText('No remaining holdings', pieCtx.width/2, pieCtx.height/2);
                }
            }
            // Value allocation - using book value (avg price * net weight)
            const valueCtx = document.getElementById('valueAllocationChart');
            if (valueCtx) {
                if (valueAllocationChart) valueAllocationChart.destroy();
       
                const goldBookValue = data.goldNetWeight * data.goldAvgPrice;
                const silverBookValue = data.silverNetWeight * data.silverAvgPrice;
                const totalBookValue = goldBookValue + silverBookValue;
                if (totalBookValue > 0) {
                    const valueCanvas = valueCtx.getContext('2d');
                    valueAllocationChart = new Chart(valueCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['Gold', 'Silver'],
                            datasets: [{
                                data: [goldBookValue, silverBookValue],
                                backgroundColor: ['#bb9b5f', '#c0c0c0'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#374151', position: 'bottom' }
                                },
                                title: {
                                    display: true,
                                    text: 'Book Value Allocation',
                                    color: '#0f4c75',
                                    font: { size: 16, weight: 'bold' }
                                }
                            },
                            animation: { duration: 1000, easing: 'easeOutQuart' }
                        }
                    });
                } else {
                    const ctx = valueCtx.getContext('2d');
                    ctx.clearRect(0, 0, valueCtx.width, valueCtx.height);
                    ctx.font = '16px Inter';
                    ctx.fillStyle = '#6b7280';
                    ctx.textAlign = 'center';
                    ctx.fillText('No book value', valueCtx.width/2, valueCtx.height/2);
                }
            }
            // Profit bar
            const profitCtxFinal = document.getElementById('profitBarChart');
            if (profitCtxFinal) {
                if (profitBarChart) profitBarChart.destroy();
       
                const profitCanvas = profitCtxFinal.getContext('2d');
                const goldColor = data.goldProfit >= 0 ? '#2d8c5e' : '#c74b50';
                const silverColor = data.silverProfit >= 0 ? '#2d8c5e' : '#c74b50';
                profitBarChart = new Chart(profitCanvas, {
                    type: 'bar',
                    data: {
                        labels: ['Gold', 'Silver'],
                        datasets: [{
                            label: 'Realized Profit/Loss (SP - CP)',
                            data: [data.goldProfit, data.silverProfit],
                            backgroundColor: [goldColor, silverColor]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                            y: {
                                ticks: {
                                    color: '#6b7280',
                                    callback: function(value) {
                                        return '₹' + value.toLocaleString('en-IN');
                                    }
                                },
                                grid: { color: '#e5e7eb' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#374151' } },
                            title: {
                                display: true,
                                text: 'Realized Profit/Loss by Metal (SP - CP)',
                                color: '#0f4c75',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        animation: { duration: 1000, easing: 'easeOutQuart' }
                    }
                });
            }
        }
        // Generate yearly report
        function generateYearlyReport() {
            const year = prompt('Enter the year for the report (e.g., 2025):');
            if (!year) return;
            const yearlyTransactions = transactions.filter(t => new Date(t.date || t.saleDate).getFullYear() == year);
            if (yearlyTransactions.length === 0) {
                showToast('No transactions found for ' + year, 'error');
                return;
            }
            exportPDF(year);
            showToast('Yearly report generated!');
        }
        // Export to PDF - Improved for nicer, clearer layout with better fonts and styling
        function exportPDF(year = null) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, mm, A4
            const today = new Date().toLocaleDateString('en-IN');
            let title = 'MetalRecord - Transaction Report';
            if (year) title += ` - ${year}`;
          
            // Improved header with gradient-like background and larger, bolder font
            doc.setFillColor(15, 76, 117); // Primary blue
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(22);
            doc.text(title, 105, 20, { align: 'center' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text(`Generated on: ${today}`, 105, 28, { align: 'center' });
            doc.setDrawColor(255, 255, 255);
            doc.setLineWidth(1);
            doc.line(20, 35, 190, 35); // Subtle underline for header
            doc.setTextColor(0, 0, 0);
          
            let y = 50; // Increased from 45 to 50 for more spacing after header
          
            const filteredTransactions = year ? transactions.filter(t => new Date(t.date || t.saleDate).getFullYear() == year) : transactions;
            const metals = ['Gold', 'Silver'];
          
            metals.forEach(metal => {
                const metalTransactions = filteredTransactions.filter(t => t.metal === metal);
              
                if (metalTransactions.length > 0) {
                    // Metal header with bold, larger font and accent color
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor(187, 155, 95); // Secondary gold color
                    doc.text(`${metal} Transactions`, 20, y);
                    y += 12; // Increased from 8 to 12 for more spacing
                  
                    const purchaseTransactions = metalTransactions.filter(t => t.type !== 'sale')
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                  
                    if (purchaseTransactions.length > 0) {
                        // Purchase subheader
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(14);
                        doc.setTextColor(45, 140, 94); // Success green
                        doc.text('Purchase Transactions', 25, y);
                        y += 10; // Increased from 8 to 10 for more spacing
                      
                        // Improved table for purchases
                        doc.autoTable({
                            startY: y,
                            head: [['Date', 'Weight (g)', 'Price/g', 'Total Amount', 'Currency', 'Source/Notes']],
                            body: purchaseTransactions.map(t => [
                                new Date(t.date).toLocaleDateString('en-IN'),
                                t.weight.toFixed(2),
                                pdfFormatAmount(t.pricePerGram),
                                pdfFormatAmount(t.total),
                                t.currency || 'INR',
                                t.source || '-'
                            ]),
                            theme: 'grid',
                            styles: {
                                font: 'helvetica',
                                fontStyle: 'normal',
                                fontSize: 8,
                                cellPadding: 6,
                                textColor: [30, 30, 30],
                                halign: 'left',
                                valign: 'middle',
                                lineColor: [220, 220, 220],
                                lineWidth: 0.2,
                                overflow: 'linebreak'
                            },
                            headStyles: {
                                fillColor: [45, 140, 94],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                fontSize: 10,
                                halign: 'center',
                                valign: 'middle'
                            },
                            alternateRowStyles: {
                                fillColor: [248, 250, 252]
                            },
                            columnStyles: {
                                0: { halign: 'left' },
                                1: { halign: 'right' },
                                2: { halign: 'right', overflow: 'linebreak' },
                                3: { halign: 'right', overflow: 'linebreak' },
                                4: { halign: 'center' },
                                5: { halign: 'left', overflow: 'linebreak' }
                            },
                            margin: { left: 20, right: 20 }
                        });
                        y = doc.lastAutoTable.finalY + 15; // Increased from 12 to 15 for more spacing
                    }
                  
                    const saleTransactions = metalTransactions.filter(t => t.type === 'sale')
                        .sort((a, b) => {
                            const aDate = a.saleDate || a.date;
                            const bDate = b.saleDate || b.date;
                            return new Date(bDate) - new Date(aDate);
                        });
                  
                    if (saleTransactions.length > 0) {
                        // Sale subheader
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(14);
                        doc.setTextColor(199, 75, 80);
                        doc.text('Sale Transactions', 25, y);
                        y += 10; // Increased from 8 to 10 for more spacing
                      
                        // Improved table for sales
                        doc.autoTable({
                            startY: y,
                            head: [['Sale Date', 'Weight (g)', 'Price/g', 'Total Amount', 'Currency', 'Source/Notes']],
                            body: saleTransactions.map(t => [
                                new Date(t.saleDate || t.date).toLocaleDateString('en-IN'),
                                t.weight.toFixed(2),
                                pdfFormatAmount(t.pricePerGram),
                                pdfFormatAmount(t.total),
                                t.currency || 'INR',
                                t.source || '-'
                            ]),
                            theme: 'grid',
                            styles: {
                                font: 'helvetica',
                                fontStyle: 'normal',
                                fontSize: 8,
                                cellPadding: 6,
                                textColor: [30, 30, 30],
                                halign: 'left',
                                valign: 'middle',
                                lineColor: [220, 220, 220],
                                lineWidth: 0.2,
                                overflow: 'linebreak'
                            },
                            headStyles: {
                                fillColor: [199, 75, 80],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                fontSize: 10,
                                halign: 'center',
                                valign: 'middle'
                            },
                            alternateRowStyles: {
                                fillColor: [248, 250, 252]
                            },
                            columnStyles: {
                                0: { halign: 'left' },
                                1: { halign: 'right' },
                                2: { halign: 'right', overflow: 'linebreak' },
                                3: { halign: 'right', overflow: 'linebreak' },
                                4: { halign: 'center' },
                                5: { halign: 'left', overflow: 'linebreak' }
                            },
                            margin: { left: 20, right: 20 }
                        });
                        y = doc.lastAutoTable.finalY + 15; // Increased from 12 to 15 for more spacing
                    }
                  
                    // Add extra spacing between metals
                    y += 10; // Increased from 8 to 10 for more spacing
                }
            });
          
            // Improved footer on each page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text('MetalRecord - Gold & Silver Tracker | Confidential Transaction Record', 105, 295, { align: 'center' });
            }
          
            const fileName = year ? `MetalRecord-Yearly-Report-${year}-${today.replace(/\//g, '-')}.pdf` : `MetalRecord-Transaction-Report-${today.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
            showToast('Report PDF exported successfully!');
        }
        // Export CSV
        function exportCSV() {
            let csv = 'Type,Metal,Date,Weight (g),Price/g,Total,Currency,Source/Notes\n';
            transactions.forEach(t => {
                const type = t.type === 'sale' ? 'Sale' : 'Purchase';
                const date = t.type === 'sale' ? (t.saleDate || t.date) : t.date;
                csv += `"${type}","${t.metal}","${date}","${t.weight.toFixed(2)}","${t.pricePerGram.toFixed(2)}","${t.total.toFixed(2)}","${t.currency || 'INR'}","${t.source || ''}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metalrecord-transactions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('CSV exported successfully!');
        }
        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type === 'error' ? 'error' : ''} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        // Close modals on outside click
        window.onclick = (e) => {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        };
        // BACKUP & SYNC FUNCTIONS
        function exportData() {
            const dataStr = localStorage.getItem('metalrecord-transactions') || '[]';
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metalrecord-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        }
        // De-duplicate function (merge identical transactions)
        function deduplicateTransactions(transList) {
            const merged = [];
            transList.forEach(trans => {
                const index = findAndMergeDuplicate(trans, merged);
                if (index !== -1) {
                    // Merge
                    merged[index].weight += trans.weight;
                    merged[index].total += trans.total;
                } else {
                    // Add new
                    merged.push({ ...trans });
                }
            });
            return merged;
        }
        // Import data - merges with existing and de-dupes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            let importedData = JSON.parse(e.target.result);
                            if (Array.isArray(importedData)) {
                                // Get existing data
                                let existingData = JSON.parse(localStorage.getItem('metalrecord-transactions') || '[]');
                                // Combine existing + imported
                                const combinedData = [...existingData, ...importedData];
                                // De-dupe combined data
                                const dedupedData = deduplicateTransactions(combinedData);
                                localStorage.setItem('metalrecord-transactions', JSON.stringify(dedupedData));
                                transactions = dedupedData;
                                updateSummary();
                                updateTransactionSections();
                                updateCharts();
                                updateRecentTransactions();
                                updateGoalsProgress();
                                showToast(`Data imported and merged (${dedupedData.length} unique transactions total)!`);
                            } else {
                                showToast('Invalid data format', 'error');
                            }
                        } catch (error) {
                            showToast('Error reading file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            });
        });
        function showManualBackup() {
            let data = JSON.parse(localStorage.getItem('metalrecord-transactions') || '[]');
            // De-dupe before backup
            data = deduplicateTransactions(data);
            localStorage.setItem('metalrecord-transactions', JSON.stringify(data));
            transactions = data;
            document.getElementById('backupData').value = JSON.stringify(data, null, 2);
            document.getElementById('manualBackupSection').style.display = 'block';
            showToast('Backup data de-duped and ready!');
        }
        function hideManualBackup() {
            document.getElementById('manualBackupSection').style.display = 'none';
        }
        function copyBackupData() {
            const backupData = document.getElementById('backupData');
            backupData.select();
            backupData.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showToast('Backup data copied to clipboard!');
        }
        // Restore from backup - merges with existing and de-dupes
        function restoreFromBackup() {
            const restoreData = document.getElementById('restoreData').value.trim();
            if (!restoreData) {
                showToast('Please enter backup data', 'error');
                return;
            }
            try {
                let importedData = JSON.parse(restoreData);
                if (Array.isArray(importedData)) {
                    // Get existing data
                    let existingData = JSON.parse(localStorage.getItem('metalrecord-transactions') || '[]');
                    // Combine existing + imported
                    const combinedData = [...existingData, ...importedData];
                    // De-dupe combined data
                    const dedupedData = deduplicateTransactions(combinedData);
                    localStorage.setItem('metalrecord-transactions', JSON.stringify(dedupedData));
                    transactions = dedupedData;
                    updateSummary();
                    updateTransactionSections();
                    updateCharts();
                    updateRecentTransactions();
                    updateGoalsProgress();
                    document.getElementById('restoreData').value = '';
                    showToast(`Data restored and merged (${dedupedData.length} unique transactions total)!`);
                } else {
                    showToast('Invalid backup data format', 'error');
                }
            } catch (error) {
                showToast('Error parsing backup data', 'error');
            }
        }
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                localStorage.removeItem('metalrecord-transactions');
                localStorage.removeItem('metalrecord-goals');
                transactions = [];
                goals = { Gold: { target: 0, date: '', notes: '' }, Silver: { target: 0, date: '', notes: '' } };
                updateSummary();
                updateTransactionSections();
                updateCharts();
                updateRecentTransactions();
                updateGoalsProgress();
                showToast('All data cleared successfully!');
            }
        }
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('addDate').valueAsDate = today;
   
            // Initial de-dupe on load
            transactions = deduplicateTransactions(transactions);
            localStorage.setItem('metalrecord-transactions', JSON.stringify(transactions));
   
            document.querySelector('[data-section="dashboard"]').classList.add('active');
   
            document.querySelectorAll('.type-option').forEach(option => {
                option.addEventListener('click', () => {
                    updateTransactionType(option.dataset.type);
                });
            });
   
            document.getElementById('searchInput').addEventListener('input', globalSearch);
   
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section;
                    if (sectionId) showSection(sectionId);
                });
            });
   
            document.getElementById('hamburger').addEventListener('click', toggleMenu);
   
            document.getElementById('searchToggle').addEventListener('click', toggleSearch);
   
            document.getElementById('overlay').addEventListener('click', toggleMenu);
   
            // Add form
            document.getElementById('addForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const type = currentTransactionType;
                const metal = document.getElementById('addMetal').value;
                const currency = document.getElementById('addCurrency').value;
                const date = document.getElementById('addDate').value;
                const weight = parseFloat(document.getElementById('addWeight').value);
                let pricePerGram = parseFloat(document.getElementById('addPricePerGram').value) || 0;
                const source = document.getElementById('addSource').value.trim();
                const saleDate = type === 'sale' ? document.getElementById('addSaleDate').value : null;
                if (!metal || !date || isNaN(weight)) {
                    showToast('Please fill in all required fields.', 'error');
                    return;
                }
                if (type === 'sale' && !saleDate) {
                    showToast('Please provide a sale date for sales.', 'error');
                    return;
                }
                if (pricePerGram === 0) pricePerGram = getStandardPrice(metal);
                const total = weight * pricePerGram;
                const newId = Date.now();
                const transactionData = {
                    id: newId,
                    type,
                    metal,
                    currency,
                    date,
                    weight,
                    pricePerGram,
                    total,
                    source
                };
       
                if (type === 'sale') {
                    transactionData.saleDate = saleDate;
                }
       
                // Check for duplicate and merge
                const duplicateIndex = findAndMergeDuplicate(transactionData);
                if (duplicateIndex !== -1) {
                    // Merge into existing
                    transactions[duplicateIndex].weight += weight;
                    transactions[duplicateIndex].total += total;
                    localStorage.setItem('metalrecord-transactions', JSON.stringify(transactions));
                    showToast(`Merged duplicate transaction for ${metal} (${weight.toFixed(2)}g added)!`);
                } else {
                    // Add new
                    transactions.push(transactionData);
                    localStorage.setItem('metalrecord-transactions', JSON.stringify(transactions));
                    showToast('Transaction added successfully!');
                }
                document.getElementById('addForm').reset();
                document.getElementById('addDate').valueAsDate = today;
                updateSummary();
                updateTransactionSections();
                updateCharts();
                updateRecentTransactions();
                updateGoalsProgress();
            });
            // Edit form
            document.getElementById('editForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const type = document.getElementById('editType').value;
                const metal = document.getElementById('editMetal').value;
                const currency = document.getElementById('editCurrency').value;
                const date = document.getElementById('editDate').value;
                const weight = parseFloat(document.getElementById('editWeight').value);
                let pricePerGram = parseFloat(document.getElementById('editPricePerGram').value) || 0;
                const source = document.getElementById('editSource').value.trim();
                const saleDate = type === 'sale' ? document.getElementById('editSaleDate').value : null;
                if (!metal || !date || isNaN(weight)) {
                    showToast('Please fill in all required fields.', 'error');
                    return;
                }
                if (type === 'sale' && !saleDate) {
                    showToast('Please provide a sale date for sales.', 'error');
                    return;
                }
                if (pricePerGram === 0) pricePerGram = getStandardPrice(metal);
                const total = weight * pricePerGram;
                const index = transactions.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    const transactionData = {
                        id: editingId,
                        type,
                        metal,
                        currency,
                        date,
                        weight,
                        pricePerGram,
                        total,
                        source
                    };
           
                    if (type === 'sale') {
                        transactionData.saleDate = saleDate;
                    }
           
                    transactions[index] = transactionData;
                    localStorage.setItem('metalrecord-transactions', JSON.stringify(transactions));
                    showToast('Transaction updated successfully!');
                    closeModal();
                    updateSummary();
                    updateTransactionSections();
                    updateCharts();
                    updateRecentTransactions();
                    updateGoalsProgress();
                }
            });
            document.getElementById('editType').addEventListener('change', function() {
                const saleDateContainer = document.getElementById('editSaleDateContainer');
                if (this.value === 'sale') {
                    saleDateContainer.style.display = 'block';
                    document.getElementById('editSaleDate').required = true;
                } else {
                    saleDateContainer.style.display = 'none';
                    document.getElementById('editSaleDate').required = false;
                }
            });
            // Goals form
            document.getElementById('goalsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const metal = document.getElementById('goalMetal').value;
                if (!metal) {
                    showToast('Please select a metal for the goal.', 'error');
                    return;
                }
                const target = parseFloat(document.getElementById('targetWeight').value) || 0;
                const date = document.getElementById('targetDate').value;
                const notes = document.getElementById('goalNotes').value.trim();
                if (target <= 0) {
                    showToast('Please enter a valid target weight.', 'error');
                    return;
                }
                goals[metal] = { target, date, notes };
                localStorage.setItem('metalrecord-goals', JSON.stringify(goals));
                showToast(`${metal} goal saved successfully!`);
                document.getElementById('goalsForm').reset();
                updateGoalsProgress();
            });
            // Edit goal form
            document.getElementById('editGoalForm').addEventListener('submit', (e) => {
                e.preventDefault();
                if (!editingGoalMetal) return;
                const metal = document.getElementById('editGoalMetal').value;
                const target = parseFloat(document.getElementById('editTargetWeight').value) || 0;
                const date = document.getElementById('editTargetDate').value;
                const notes = document.getElementById('editGoalNotes').value.trim();
                if (target <= 0) {
                    showToast('Please enter a valid target weight.', 'error');
                    return;
                }
                goals[metal] = { target, date, notes };
                localStorage.setItem('metalrecord-goals', JSON.stringify(goals));
                showToast(`${metal} goal updated successfully!`);
                closeGoalModal();
                updateGoalsProgress();
            });
            // Standard price fallback
            function getStandardPrice(metal) {
                const basePrices = { Gold: 12508, Silver: 169 };
                return basePrices[metal] || 0;
            }
            // Initialize
            updateSummary();
            updateTransactionSections();
            updateCharts();
            updateRecentTransactions();
            updateGoalsProgress();
        });
    </script>
</body>
</html>